{% extends 'food/base.html' %}

{% block title %}AI Chef - Smart Recipe Generator{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12 text-center">
        <h1 class="display-6 fw-bold text-primary mb-2">
            <i class="bi bi-robot"></i> AI Chef
        </h1>
        <p class="text-muted">I'll create recipes using your available ingredients, prioritizing what's expiring soon.
        </p>
    </div>
</div>

<div class="row justify-content-center" id="chefWorkspace">
    <div class="col-lg-8">
        <!-- Ingredients Summary -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="bi bi-basket2"></i> Your Kitchen Inventory</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <h6 class="text-danger fw-bold"><i class="bi bi-clock-history"></i> Priority Ingredients (Expiring
                        Soon)</h6>
                    {% if expiring_items %}
                    <div class="d-flex flex-wrap gap-2">
                        {% for item in expiring_items %}
                        <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">
                            {{ item.grocery_name }}
                        </span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted small">No items expiring within 7 days.</p>
                    {% endif %}
                </div>

                <hr>

                <div class="mb-3">
                    <h6 class="text-primary fw-bold"><i class="bi bi-check-circle"></i> Other Available Ingredients</h6>
                    {% if other_items %}
                    <div class="d-flex flex-wrap gap-2">
                        {% for item in other_items %}
                        <span class="badge bg-light text-dark border">
                            {{ item.grocery_name }}
                        </span>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted small">No other items found.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Preferences Form -->
        <div class="card shadow-sm mb-4 border-0">
            <div class="card-body">
                <div class="mb-3">
                    <label for="servings" class="form-label fw-bold">Number of People to Serve</label>
                    <input type="number" class="form-control" id="servings" value="2" min="1" max="20">
                </div>
                <label for="preferences" class="form-label fw-bold">Dietary Preferences or Cravings (Optional)</label>
                <textarea class="form-control" id="preferences" rows="2"
                    placeholder="e.g., Vegetarian, low carb, spicy, I want a soup..."></textarea>
            </div>
        </div>

        <!-- Generate Button -->
        <div class="d-grid gap-2">
            <button id="generateBtn" class="btn btn-primary btn-lg shadow-sm py-3 rounded-pill">
                <i class="bi bi-magic"></i> Generate Recipes
            </button>
        </div>
    </div>
</div>

<!-- Loading State -->
<div id="loadingState" class="text-center py-5 d-none">
    <div class="spinner-grow text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
    </div>
    <h4 class="text-muted animate-pulse">Our AI Chef is cooking up ideas...</h4>
    <p class="text-muted small">Using your {{ total_count }} ingredients to find the perfect meal.</p>
</div>

<!-- Results Container -->
<div id="resultsContainer" class="d-none">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h3 class="fw-bold">Suggested Recipes</h3>
            <button onclick="location.reload()" class="btn btn-outline-primary btn-sm rounded-pill">
                <i class="bi bi-arrow-repeat"></i> Start Over
            </button>
        </div>
    </div>
    <div id="recipesContent" class="row g-4">
        <!-- AI Response will be injected here -->
    </div>
</div>

<script>
    document.getElementById('generateBtn').addEventListener('click', async function () {
        const preferences = document.getElementById('preferences').value;
        const servings = document.getElementById('servings').value;
        const workspace = document.getElementById('chefWorkspace');
        const loading = document.getElementById('loadingState');
        const results = document.getElementById('resultsContainer');
        const recipesContent = document.getElementById('recipesContent');

        // Show loading
        workspace.classList.add('d-none');
        loading.classList.remove('d-none');

        try {
            const url = "{% url 'generate_recipes_api' %}";
            console.log("Fetching URL:", url);

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    preferences: preferences,
                    servings: servings
                })
            });

            console.log("Response Status:", response.status);

            const text = await response.text();
            console.log("Response Text:", text.substring(0, 200)); // Log first 200 chars

            // Check if response is HTML (likely redirected to login page)
            if (response.redirected || text.trim().startsWith('<')) {
                alert('Session expired. Please log in again.');
                window.location.href = "{% url 'signin' %}";
                return;
            }

            try {
                const data = JSON.parse(text);

                if (data.status === 'success') {
                    loading.classList.add('d-none');
                    renderRecipes(data.recipes);
                    results.classList.remove('d-none');
                } else {
                    alert('Error: ' + data.message);
                    location.reload();
                }
            } catch (e) {
                console.error("JSON Parse Error:", e);
                // If not JSON, it's likely an HTML error page
                if (!response.ok) {
                    alert(`Server Error (${response.status}): ${text.substring(0, 100)}...`);
                } else {
                    alert(`Unexpected response format: ${e.message}\nRaw Text Start: ${text.substring(0, 100)}`);
                }
                location.reload();
            }

        } catch (error) {
            console.error('Network Error:', error);
            alert('Failed to connect to AI Chef (Network Error). Check console for details.');
            location.reload();
        }
    });

    function renderRecipes(recipes) {
        const container = document.getElementById('recipesContent');
        container.innerHTML = '';

        recipes.forEach((recipe, index) => {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';

            // -----------------------------------------------------
            // 1. Normalize Ingredients IN-PLACE (for UI + Save)
            // -----------------------------------------------------
            let ingredients = recipe.ingredients;
            if (!Array.isArray(ingredients)) {
                if (typeof ingredients === 'object' && ingredients !== null) {
                    // Convert {"Name": "Qty"} -> ["Qty Name"] for better backend parsing
                    // e.g. {"Milk": "1 cup"} -> "1 cup Milk"
                    recipe.ingredients = Object.entries(ingredients).map(([k, v]) => `${v} ${k}`);
                } else if (typeof ingredients === 'string') {
                    recipe.ingredients = [ingredients];
                } else {
                    recipe.ingredients = [];
                }
            }
            // Ensure simple strings
            recipe.ingredients = recipe.ingredients.map(String);

            // -----------------------------------------------------
            // 2. Normalize Instructions IN-PLACE (for UI + Save)
            // -----------------------------------------------------
            let instructions = recipe.instructions;
            if (!Array.isArray(instructions)) {
                // Split by newline or steps if string
                recipe.instructions = String(instructions || '').split(/\n|\d+\.\s+/).filter(s => s.trim().length > 0);
            }

            // -----------------------------------------------------
            // 3. Render
            // -----------------------------------------------------
            // Build ingredients list HTML
            const ingredientsHtml = recipe.ingredients.map(ing => `<li>${ing}</li>`).join('');

            // Clean up instructions for display
            const instructionsHtml = recipe.instructions.map(step => {
                // Remove leading "Step 1:", "1.", "- ", etc.
                const cleanStep = step.replace(/^(?:Step\s+\d+:|\d+\.|^[\*\-•])\s*/i, '').trim();
                return `<li>${cleanStep}</li>`;
            }).join('');

            col.innerHTML = `
            <div class="card h-100 shadow-sm border-0 recipe-card">
                <div class="card-header bg-gradient bg-primary text-white p-3">
                    <h5 class="card-title mb-0 fw-bold">${recipe.name}</h5>
                    <div class="small mt-1 opacity-75">
                         <i class="bi bi-clock"></i> ${recipe.time} • 
                         <i class="bi bi-fire"></i> ${recipe.calories || 'N/A'} / serving •
                         <i class="bi bi-people"></i> Serves ${recipe.servings || '2'} •
                         <span class="badge bg-light text-primary bg-opacity-25 border border-white border-opacity-25">${recipe.difficulty}</span>
                    </div>
                </div>
                <div class="card-body">
                    ${recipe.description ? `<p class="card-text text-muted small mb-3">${recipe.description}</p>` : ''}
                    ${recipe.uses_expiring ? '<div class="mb-3"><span class="badge bg-success bg-opacity-10 text-success border border-success"><i class="bi bi-star-fill"></i> Uses Expiring Items</span></div>' : ''}
                    
                    ${recipe.macros ? `
                    <div class="mb-3 border-bottom pb-3">
                        <div class="text-center mb-2">
                             <small class="text-muted text-uppercase fw-bold" style="font-size: 0.7rem;">Nutritional Info (Per Serving)</small>
                        </div>
                        <div class="d-flex gap-2 justify-content-around">
                            <div class="text-center">
                                <small class="text-muted d-block" style="font-size: 0.7rem;">PROTEIN</small>
                                <span class="fw-bold text-dark">${recipe.macros.protein}</span>
                            </div>
                            <div class="text-center">
                                <small class="text-muted d-block" style="font-size: 0.7rem;">CARBS</small>
                                <span class="fw-bold text-dark">${recipe.macros.carbs}</span>
                            </div>
                            <div class="text-center">
                                <small class="text-muted d-block" style="font-size: 0.7rem;">FATS</small>
                                <span class="fw-bold text-dark">${recipe.macros.fats}</span>
                            </div>
                        </div>
                    </div>` : ''}
                    
                    <div class="mb-3">
                        <h6 class="text-primary fw-bold text-uppercase small border-bottom pb-1">Ingredients</h6>
                        <ul class="list-unstyled small mb-0 ps-2" style="border-left: 3px solid #e9ecef;">
                            ${ingredientsHtml}
                        </ul>
                    </div>
                    
                    <div>
                        <h6 class="text-primary fw-bold text-uppercase small border-bottom pb-1">Instructions</h6>
                        <ol class="small ps-3 mb-0 text-muted">
                            ${instructionsHtml}
                        </ol>
                    </div>
                </div>
                <div class="card-footer bg-white border-0 pt-0 pb-3">
                    <div class="d-grid">
                        <button class="btn btn-outline-primary btn-save" onclick="saveRecipe(this, ${index})">
                            <i class="bi bi-bookmark"></i> Save Recipe
                        </button>
                    </div>
                </div>
            </div>
        `;

            // Store (now normalized) recipe data on the button for saving
            const btn = col.querySelector('.btn-save');
            btn.dataset.recipe = JSON.stringify(recipe);

            container.appendChild(col);
        });
    }

    async function saveRecipe(btn, index) {
        const recipe = JSON.parse(btn.dataset.recipe);
        btn.disabled = true;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Saving...';

        try {
            // Convert ingredients array to object for backend compatibility
            const ingredientsObj = {};
            if (recipe.ingredients && Array.isArray(recipe.ingredients)) {
                recipe.ingredients.forEach(ing => {
                    const cleanIng = ing.replace(/^[•\-\*]\s*/, ''); // Clean bullets if present
                    ingredientsObj[cleanIng] = "1"; // Default quantity, backend parses name for qty
                });
            }

            // Prepare Description and Instructions separately
            const description = recipe.description || '';
            let instructionsText = '';

            if (recipe.instructions && Array.isArray(recipe.instructions)) {
                instructionsText = recipe.instructions.join('\n');
            } else {
                instructionsText = recipe.instructions || '';
            }

            const response = await fetch("{% url 'save_recipe' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    recipe_name: recipe.name,
                    description: description,
                    instructions: instructionsText,
                    cooking_time: recipe.time,
                    ingredients: ingredientsObj,
                    calories: recipe.calories || '',
                    macros: recipe.macros || {}
                })
            });

            const data = await response.json();

            if (data.status === 'success') {
                btn.className = 'btn btn-success';
                btn.innerHTML = '<i class="bi bi-check-circle"></i> Saved';
            } else {
                alert('Error: ' + data.message);
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        } catch (error) {
            console.error('Save error:', error);
            alert('Failed to save recipe.');
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>

<style>
    @keyframes pulse {
        0% {
            opacity: 0.5;
        }

        50% {
            opacity: 1;
        }

        100% {
            opacity: 0.5;
        }
    }

    .animate-pulse {
        animation: pulse 2s infinite;
    }

    .bg-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    }

    .recipe-card {
        transition: transform 0.2s;
    }

    .recipe-card:hover {
        transform: translateY(-5px);
    }
</style>
{% endblock %}