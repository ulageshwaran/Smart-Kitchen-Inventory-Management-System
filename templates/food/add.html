{% extends 'food/base.html' %}
{% block title %}{% if is_editing %}Edit Grocery{% else %}Add Grocery{% endif %}{% endblock %}

{% block content %}
<h2 class="mb-4">{% if is_editing %}Edit Grocery{% else %}Add Grocery{% endif %}</h2>

<form method="post" class="row g-3">
    {% csrf_token %}
    <div class="col-md-6">
        <label for="grocery_name" class="form-label">Name</label>
        <input type="text" class="form-control" id="grocery_name" name="grocery_name"
            value="{{ form.grocery_name.value|default:'' }}" required>
    </div>

 <div class="col-md-6">
        <label for="manufacturing_date" class="form-label">Manufacturing Date</label>
        <input type="date" class="form-control" id="manufacturing_date" name="manufacturing_date"
            value="{{ form.manufacturing_date.value|default:'' }}">
        <small class="text-muted">Expiry date will be auto-calculated based on category if left empty.</small>
    </div>

    <div class="col-md-6">
        <label for="ex_date" class="form-label">Expiry Date</label>
        <input type="date" class="form-control" id="ex_date" name="ex_date" value="{{ form.ex_date.value|default:'' }}"
            required>
    </div>

    <div class="col-md-3">
        <label for="quantity" class="form-label">Quantity</label>
        <input type="number" step="0.1" class="form-control" id="quantity" name="quantity"
            value="{{ form.quantity.value|default:'' }}" required>
    </div>

    <div class="col-md-3">
        <label for="unit" class="form-label">Unit</label>
        <select class="form-select" id="unit" name="unit" required>
            <option value="" {% if not form.unit.value %}selected{% endif %}>Select Unit</option>
            <optgroup label="Weight">
                <option value="kg" {% if form.unit.value == 'kg' %}selected{% endif %}>kg (kilogram)</option>
                <option value="g" {% if form.unit.value == 'g' %}selected{% endif %}>g (gram)</option>
                <option value="lb" {% if form.unit.value == 'lb' %}selected{% endif %}>lb (pound)</option>
                <option value="oz" {% if form.unit.value == 'oz' %}selected{% endif %}>oz (ounce)</option>
            </optgroup>
            <optgroup label="Volume">
                <option value="l" {% if form.unit.value == 'l' %}selected{% endif %}>l (liter)</option>
                <option value="ml" {% if form.unit.value == 'ml' %}selected{% endif %}>ml (milliliter)</option>
                <option value="cup" {% if form.unit.value == 'cup' %}selected{% endif %}>cup</option>
                <option value="tbsp" {% if form.unit.value == 'tbsp' %}selected{% endif %}>tbsp (tablespoon)</option>
                <option value="tsp" {% if form.unit.value == 'tsp' %}selected{% endif %}>tsp (teaspoon)</option>
            </optgroup>
            <optgroup label="Count">
                <option value="piece" {% if form.unit.value == 'piece' %}selected{% endif %}>piece(s)</option>
                <option value="item" {% if form.unit.value == 'item' %}selected{% endif %}>item(s)</option>
                <option value="unit" {% if form.unit.value == 'unit' %}selected{% endif %}>unit(s)</option>
                <option value="bunch" {% if form.unit.value == 'bunch' %}selected{% endif %}>bunch(es)</option>
                <option value="package" {% if form.unit.value == 'package' %}selected{% endif %}>package(s)</option>
                <option value="bag" {% if form.unit.value == 'bag' %}selected{% endif %}>bag(s)</option>
            </optgroup>
        </select>
    </div>

    <div class="col-md-6">
        <label for="grocerie_type" class="form-label">Category</label>
        <select class="form-select" id="grocerie_type" name="grocerie_type" required>
            <option value="">Select a Category</option>
            {% for code, name in category_choices %}
            <option value="{{ code }}" {% if form.grocerie_type.value == code %}selected{% endif %}>
                {{ name }}</option>
            {% endfor %}

        </select>
    </div>

   

    <div class="col-12 mt-3">
        <button type="submit" class="btn btn-primary">{% if is_editing %}Update{% else %}Add{% endif %}</button>
        <a href="{% url 'index' %}" class="btn btn-secondary">Cancel</a>
    </div>
</form>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const mfdInput = document.getElementById('manufacturing_date');
        const expInput = document.getElementById('ex_date');
        const categoryInput = document.getElementById('grocerie_type');

        // Default shelf life in days
        const shelfLife = {
            'Vegetables': 5,
            'Fruits': 5,
            'Dairy': 7,
            'Meat': 3,
            'Grains': 365,
            'Spices': 365,
            'Condiments & Seasonings': 180,
            'Beverages': 180,
            'Snacks': 90,
            'Others': 30
        };

        function updateExpiry() {
            const mfd = mfdInput.value;
            const category = categoryInput.value;

            if (mfd && category && shelfLife[category]) {
                const mfdDate = new Date(mfd);
                const days = shelfLife[category];

                const expDate = new Date(mfdDate);
                expDate.setDate(expDate.getDate() + days);

                const yyyy = expDate.getFullYear();
                const mm = String(expDate.getMonth() + 1).padStart(2, '0');
                const dd = String(expDate.getDate()).padStart(2, '0');

                expInput.value = `${yyyy}-${mm}-${dd}`;
            }
        }

        if (mfdInput && categoryInput) {
            mfdInput.addEventListener('change', updateExpiry);
            categoryInput.addEventListener('change', updateExpiry);
        }
    });
</script>
{% endblock %}